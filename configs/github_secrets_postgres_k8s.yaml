server:
  name: github_secrets_postgres_k8s_mcp
  version: "0.1.0"
  transport: "http"
  shutdown_timeout: "10s"
  idempotency_cache:
    enabled: true
    ttl: "24h"
    max_entries: 2000
    key_strategy: "auto"
  startup_hooks:
    - timeout: "10s"
      command: |
        set -euo pipefail
        command -v gh >/dev/null
        command -v kubectl >/dev/null
    - timeout: "30s"
      command: |
        set -euo pipefail
        printf %s "$YAML_MCP_GH_PAT" | gh auth login --with-token
  http:
    listen: ":8080"
    path: "/mcp"
    read_timeout: "1h"
    write_timeout: "1h"
    idle_timeout: "1h"
    session_timeout: "5m"
    stateless: false

tools:
  - name: github_create_env_secret_k8s
    title: "Create GitHub secret and Kubernetes secret"
    description: |
      Creates a GitHub environment secret and injects it into Kubernetes after approval.
      Input fields:
      - secret_name: GitHub secret name (uppercase, digits, underscores).
      - environment: GitHub environment name; allowed values: ai-staging or staging.
      - namespace: Kubernetes namespace where the K8s secret will be created.
      - k8s_secret_name: Kubernetes Secret name (kebab-case).
      - justification: required; write in language "{{ envOr "YAML_MCP_LANG" "en" }}".
      Notes:
      - GitHub repository is fixed by server configuration.
      Optional:
      - correlation_id: provide a stable id to enable idempotent responses.
      - The secret value is generated by the server, do NOT provide secret_value.
      - The K8s secret key equals secret_name.
    annotations:
      read_only_hint: false
      destructive_hint: true
      idempotent_hint: false
      open_world_hint: true
      title: "Create GitHub env secret + K8s secret"
    requires_approval: true
    timeout: "1h"
    timeout_message: "approval timeout"
    input_schema:
      type: object
      additionalProperties: false
      required: ["secret_name", "environment", "namespace", "k8s_secret_name", "justification"]
      properties:
        correlation_id:
          type: string
        secret_name:
          type: string
          pattern: "^[A-Z0-9_]+$"
        environment:
          type: string
          enum: ["ai-staging", "staging"]
        namespace:
          type: string
          pattern: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
        k8s_secret_name:
          type: string
          pattern: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
        justification:
          type: string
    output_schema:
      type: object
      additionalProperties: false
      required: ["status", "decision", "correlation_id"]
      properties:
        status:
          type: string
          enum: ["success", "denied", "error"]
        decision:
          type: string
          enum: ["approve", "deny", "error"]
        reason:
          type: string
        correlation_id:
          type: string
    approvers:
      - type: limits
        fields:
          secret_name:
            regex: "^[A-Z0-9_]+$"
          environment:
            regex: "^(ai-staging|staging)$"
          namespace:
            regex: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
          k8s_secret_name:
            regex: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
      - type: shell
        timeout: "1m"
        command: |
          set -euo pipefail
          repo="{{ env "YAML_MCP_GITHUB_REPO" }}"
          if gh secret list -R "$repo" | awk '{print $1}' | grep -qx "{{ "{{ .Args.secret_name }}" }}"; then
            echo "secret already exists"
            exit 1
          fi
          exit 0
      - type: http
        timeout: "1h"
        url: '{{ env "YAML_MCP_APPROVER_URL" }}'
    executor:
      type: shell
      timeout: "1h"
      command: |
        set -euo pipefail
        secret_value="$(head -c 32 /dev/urandom | base64)"
          repo="{{ env "YAML_MCP_GITHUB_REPO" }}"
          gh api -X PUT "repos/$repo/environments/{{ "{{ .Args.environment }}" }}" >/dev/null
          gh secret set {{ "{{ .Args.secret_name }}" }} -R "$repo" --env {{ "{{ .Args.environment }}" }} --body "$secret_value"
          kubectl -n {{ "{{ .Args.namespace }}" }} create secret generic {{ "{{ .Args.k8s_secret_name }}" }} \\
            --from-literal={{ "{{ .Args.secret_name }}" }}="$secret_value" \\
            --dry-run=client -o yaml | kubectl apply -f -
          echo "secret {{ "{{ .Args.secret_name }}" }} created in $repo env {{ "{{ .Args.environment }}" }} and injected into {{ "{{ .Args.namespace }}" }}/{{ "{{ .Args.k8s_secret_name }}" }}"
  - name: k8s_create_postgres_db
    title: "Create PostgreSQL database in Kubernetes"
    description: |
      Creates a PostgreSQL database after approval by reading DB credentials from Kubernetes Secrets.
      Input fields:
      - namespace: Kubernetes namespace where PostgreSQL runs.
      - db_name: database name (lowercase, digits, underscores).
      - k8s_pg_user_secret_name: Kubernetes Secret name that stores DB user.
      - pg_user_secret_name: key inside that secret with DB user.
      - k8s_pg_password_secret_name: Kubernetes Secret name that stores DB password.
      - pg_password_secret_name: key inside that secret with DB password.
      - justification: required; write in language "{{ envOr "YAML_MCP_LANG" "en" }}".
      Optional:
      - correlation_id: provide a stable id to enable idempotent responses.
      Environment:
      - Pod selector (optional): pod label selector, default "app=postgres".
    annotations:
      read_only_hint: false
      destructive_hint: true
      idempotent_hint: false
      open_world_hint: true
      title: "Create PostgreSQL DB"
    requires_approval: true
    timeout: "1h"
    timeout_message: "approval timeout"
    input_schema:
      type: object
      additionalProperties: false
      required: ["namespace", "db_name", "k8s_pg_user_secret_name", "pg_user_secret_name", "k8s_pg_password_secret_name", "pg_password_secret_name", "justification"]
      properties:
        correlation_id:
          type: string
        namespace:
          type: string
          pattern: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
        db_name:
          type: string
          pattern: "^[a-z][a-z0-9_]{2,62}$"
        k8s_pg_user_secret_name:
          type: string
          pattern: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
        pg_user_secret_name:
          type: string
          pattern: "^[A-Z0-9_]+$"
        k8s_pg_password_secret_name:
          type: string
          pattern: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
        pg_password_secret_name:
          type: string
          pattern: "^[A-Z0-9_]+$"
        justification:
          type: string
    output_schema:
      type: object
      additionalProperties: false
      required: ["status", "decision", "correlation_id"]
      properties:
        status:
          type: string
          enum: ["success", "denied", "error"]
        decision:
          type: string
          enum: ["approve", "deny", "error"]
        reason:
          type: string
        correlation_id:
          type: string
    approvers:
      - type: limits
        fields:
          namespace:
            regex: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
          db_name:
            regex: "^[a-z][a-z0-9_]{2,62}$"
          k8s_pg_user_secret_name:
            regex: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
          pg_user_secret_name:
            regex: "^[A-Z0-9_]+$"
          k8s_pg_password_secret_name:
            regex: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
          pg_password_secret_name:
            regex: "^[A-Z0-9_]+$"
      - type: shell
        timeout: "1m"
        command: |
          set -euo pipefail
          selector="{{ envOr "YAML_MCP_POSTGRES_POD_SELECTOR" "app=postgres" }}"
          pod="$(kubectl -n {{ "{{ .Args.namespace }}" }} get pods -l "$selector" -o jsonpath='{.items[0].metadata.name}')"
          if [ -z "$pod" ]; then
            echo "postgres pod not found"
            exit 1
          fi
          pg_user="$(kubectl -n {{ "{{ .Args.namespace }}" }} get secret {{ "{{ .Args.k8s_pg_user_secret_name }}" }} -o jsonpath='{.data.{{ "{{ .Args.pg_user_secret_name }}" }}}' | base64 -d)"
          pg_password="$(kubectl -n {{ "{{ .Args.namespace }}" }} get secret {{ "{{ .Args.k8s_pg_password_secret_name }}" }} -o jsonpath='{.data.{{ "{{ .Args.pg_password_secret_name }}" }}}' | base64 -d)"
          if [ -z "$pg_user" ] || [ -z "$pg_password" ]; then
            echo "postgres credentials not found"
            exit 1
          fi
          if kubectl -n {{ "{{ .Args.namespace }}" }} exec "$pod" -- env PGPASSWORD="$pg_password" psql -U "$pg_user" -tAc "SELECT 1 FROM pg_database WHERE datname='{{ "{{ .Args.db_name }}" }}';" | grep -q 1; then
            echo "database already exists"
            exit 1
          fi
          exit 0
      - type: http
        timeout: "1h"
        url: '{{ env "YAML_MCP_APPROVER_URL" }}'
    executor:
      type: shell
      timeout: "1h"
      command: |
        set -euo pipefail
        selector="{{ envOr "YAML_MCP_POSTGRES_POD_SELECTOR" "app=postgres" }}"
        pod="$(kubectl -n {{ "{{ .Args.namespace }}" }} get pods -l "$selector" -o jsonpath='{.items[0].metadata.name}')"
        if [ -z "$pod" ]; then
          echo "postgres pod not found"
          exit 1
        fi
        pg_user="$(kubectl -n {{ "{{ .Args.namespace }}" }} get secret {{ "{{ .Args.k8s_pg_user_secret_name }}" }} -o jsonpath='{.data.{{ "{{ .Args.pg_user_secret_name }}" }}}' | base64 -d)"
        pg_password="$(kubectl -n {{ "{{ .Args.namespace }}" }} get secret {{ "{{ .Args.k8s_pg_password_secret_name }}" }} -o jsonpath='{.data.{{ "{{ .Args.pg_password_secret_name }}" }}}' | base64 -d)"
        if [ -z "$pg_user" ] || [ -z "$pg_password" ]; then
          echo "postgres credentials not found"
          exit 1
        fi
        kubectl -n {{ "{{ .Args.namespace }}" }} exec "$pod" -- env PGPASSWORD="$pg_password" psql -U "$pg_user" -v ON_ERROR_STOP=1 -c "CREATE DATABASE \"{{ "{{ .Args.db_name }}" }}\" OWNER \"$pg_user\";"
        echo "database {{ "{{ .Args.db_name }}" }} created in namespace {{ "{{ .Args.namespace }}" }}"
